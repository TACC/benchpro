# System Imports
import subprocess

# Local Imports
import src.cfg_handler as cfg_handler
import src.common as common_funcs
import src.exception as exception

logger = gs = ''

# Function to test if benchmark produced valid result
def validate_result(result_dir):
	# Get validation requirement from bench cfg file
	cfg_file = result_dir + gs.sl + "bench_files" + gs.sl + "bench.cfg"
	bench_cfg = cfg_handler.get_cfg('bench', cfg_file, gs, logger)

	output_file = result_dir + gs.sl + gs.output_file

	# Run validation
	if bench_cfg['validation']['method'] == 'regex':

		# replace <output> filename placeholder with value in settings.cfg
		bench_cfg['validation']['expression'] = bench_cfg['validation']['expression'].replace("<output>", result_dir + gs.sl + gs.output_file)

		try:
			print(bench_cfg['validation']['expression'])
			cmd = subprocess.run(bench_cfg['validation']['expression'], shell=True,
										 check=True, capture_output=True, universal_newlines=True)
			result = cmd.stdout.strip("\n")
			logger.debug("Pulled result from " + gs.output_file + ":  " + result + " " + bench_cfg['validation']['unit'])

		except subprocess.CalledProcessError as e:
				exception.error_and_quit(logger, "Unable to use '" + bench_cfg['validation']['expression'] + "'to find result in " + output_file )
  
	return result, bench_cfg['validation']['unit']


def capture_result(args, settings):
	global logger, gs
	gs = settings

	common = common_funcs.init(gs)
	# Start logger
	logger = common.start_logging("CAPTURE", gs.base_dir + gs.sl + gs.bench_log_file + "_" + gs.time_str + ".log")

	results = common.get_subdirs(gs.bench_path)

	for result in results:
		print(result)
		result, unit = validate_result(result)
		print(result)
		print(unit)
